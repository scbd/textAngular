"use strict";var textAngularVersion="v1.5.16",_browserDetect={ie:function(){for(var e=3,t=document.createElement("div"),n=t.getElementsByTagName("i");t.innerHTML="\x3c!--[if gt IE "+ ++e+"]><i></i><![endif]--\x3e",n[0];);return e>4?e:void 0}(),webkit:/AppleWebKit\/([\d.]+)/i.test(navigator.userAgent),isFirefox:navigator.userAgent.toLowerCase().indexOf("firefox")>-1},performance=performance||{};function stripHtmlToText(e){var t=document.createElement("DIV");t.innerHTML=e;var n=t.textContent||t.innerText||"";return n.replace("â€‹",""),n=n.trim()}function getDomFromHtml(e){var t=document.createElement("DIV");return t.innerHTML=e,t}performance.now=performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()};var sheet,addCSSRule,removeCSSRule,_addCSSRule,_removeCSSRule,_getRuleIndex,BLOCKELEMENTS=/^(address|article|aside|audio|blockquote|canvas|center|dd|div|dl|fieldset|figcaption|figure|footer|form|h1|h2|h3|h4|h5|h6|header|hgroup|hr|noscript|ol|output|p|pre|section|table|tfoot|ul|video)$/i,LISTELEMENTS=/^(ul|li|ol)$/i,VALIDELEMENTS=/^(#text|span|address|article|aside|audio|blockquote|canvas|center|dd|div|dl|fieldset|figcaption|figure|footer|form|h1|h2|h3|h4|h5|h6|header|hgroup|hr|noscript|ol|output|p|pre|section|table|tfoot|ul|video|li)$/i;if(String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),_browserDetect.ie>8||void 0===_browserDetect.ie){for(var _sheets=document.styleSheets,i=0;i<_sheets.length;i++)try{if((0===_sheets[i].media.length||_sheets[i].media.mediaText.match(/(all|screen)/gi))&&_sheets[i].href&&_sheets[i].href.match(/textangular\.(min\.|)css/gi)){sheet=_sheets[i];break}}catch(e){}sheet||(sheet=function(){var e=document.createElement("style");return _browserDetect.webkit&&e.appendChild(document.createTextNode("")),document.getElementsByTagName("head")[0].appendChild(e),e.sheet}()),addCSSRule=function(e,t){return _addCSSRule(sheet,e,t)},_addCSSRule=function(e,t,n){var a,r;return e.cssRules?a=Math.max(e.cssRules.length-1,0):e.rules&&(a=Math.max(e.rules.length-1,0)),e.insertRule?e.insertRule(t+"{"+n+"}",a):e.addRule(t,n,a),sheet.rules?r=sheet.rules[a]:sheet.cssRules&&(r=sheet.cssRules[a]),r},_getRuleIndex=function(e,t){var n,a;for(n=0;n<t.length;n++)if(t[n].cssText===e.cssText){a=n;break}return a},removeCSSRule=function(e){_removeCSSRule(sheet,e)},_removeCSSRule=function(e,t){var n=e.cssRules||e.rules;if(n&&0!==n.length){var a=_getRuleIndex(t,n);e.removeRule?e.removeRule(a):e.deleteRule(a)}}}angular.module("textAngular.factories",[]).factory("taBrowserTag",[function(){return function(e){return e?""===e?void 0===_browserDetect.ie?"div":_browserDetect.ie<=8?"P":"p":_browserDetect.ie<=8?e.toUpperCase():e:_browserDetect.ie<=8?"P":"p"}}]).factory("taApplyCustomRenderers",["taCustomRenderers","taDOM",function(e,t){return function(n){var a=angular.element("<div></div>");return a[0].innerHTML=n,angular.forEach(e,function(e){var n=[];e.selector&&""!==e.selector?n=a.find(e.selector):e.customAttribute&&""!==e.customAttribute&&(n=t.getByAttribute(a,e.customAttribute)),angular.forEach(n,function(t){t=angular.element(t),e.selector&&""!==e.selector&&e.customAttribute&&""!==e.customAttribute?void 0!==t.attr(e.customAttribute)&&e.renderLogic(t):e.renderLogic(t)})}),a[0].innerHTML}}]).factory("taFixChrome",function(){return function(e,t){if(!e||!angular.isString(e)||e.length<=0)return e;for(var n,a,r,o=/style\s?=\s?(["'])(?:(?=(\\?))\2.)*?\1/gi,l=/<span class="Apple-converted-space">([^<]+)<\/span>/gi,i="",s=0;n=l.exec(e);)r=(r=n[1]).replace(/&nbsp;/gi," "),i+=e.substring(s,n.index)+r,s=n.index+n[0].length;if(s&&(i+=e.substring(s),e=i,i="",s=0),!t){for(;n=o.exec(e);)i+=e.substring(s,n.index-1),a=n[0],(n=/font-family: inherit;|line-height: 1.[0-9]{3,12};|color: inherit; line-height: 1.1;|color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);|background-color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);/gi.exec(a))?(a=a.replace(/( |)font-family: inherit;|( |)line-height: 1.[0-9]{3,12};|( |)color: inherit;|( |)color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);|( |)background-color: rgb\(\d{1,3}, \d{1,3}, \d{1,3}\);/gi,"")).length>8&&(i+=" "+a):i+=" "+a,s=o.lastIndex;i+=e.substring(s)}return s>0?i.replace(/<span\s?>(.*?)<\/span>(<br(\/|)>|)/gi,"$1"):e}}).factory("taSanitize",["$sanitize",function(e){for(var t=[{property:"font-weight",values:["bold"],tag:"b"},{property:"font-style",values:["italic"],tag:"i"}],n=[],a=0;a<t.length;a++){for(var r="("+t[a].property+":\\s*(",o=0;o<t[a].values.length;o++)o>0&&(r+="|"),r+=t[a].values[o];r+=");)",n.push(r)}var l="("+n.join("|")+")";function i(e,t){for(var n,a=0,r=0,o=/<[^>]*>/gi;n=o.exec(e);)if(r=n.index,"/"===n[0].substr(1,1)){if(0===a)break;a--}else a++;return t+e.substring(0,r)+angular.element(t)[0].outerHTML.substring(t.length)+e.substring(r)}var s=new RegExp(/<span id="selectionBoundary_\d+_\d+" class="rangySelectionBoundary">[^<>]+?<\/span>/gi),d=new RegExp(/<span class="rangySelectionBoundary" id="selectionBoundary_\d+_\d+">[^<>]+?<\/span>/gi),c=new RegExp(/<span id="selectionBoundary_\d+_\d+" class="rangySelectionBoundary".*?>[^<>]+?<\/span>/gi),u=new RegExp(/<span class="rangySelectionBoundary" id="selectionBoundary_\d+_\d+".*?>[^<>]+?<\/span>/gi),p=new RegExp(/<span id="selectionBoundary_\d+_\d+" (style="([^"]*)") class="rangySelectionBoundary".*?>[^<>]+?<\/span>/gi);return function(n,a,r){if(!r)try{n=function e(n){if(!n||!angular.isString(n)||n.length<=0)return n;for(var a,r,o,s,d,c,u=/<([^>\/]+?)style=("([^"]+)"|'([^']+)')([^>]*)>/gi,p="",f="",m=0;r=u.exec(n);){s=r[3]||r[4];var g=new RegExp(l,"i");if(angular.isString(s)&&g.test(s)){d="";for(var h=new RegExp(l,"ig");o=h.exec(s);)for(a=0;a<t.length;a++)o[2*a+2]&&(d+="<"+t[a].tag+">");c=e(n.substring(m,r.index)),p.length>0?f+=i(c,p):f+=c,s=s.replace(new RegExp(l,"ig"),""),f+="<"+r[1].trim(),s.length>0&&(f+=' style="'+s+'"'),f+=r[5]+">",m=r.index+r[0].length,p=d}}return p.length>0?f+=i(n.substring(m),p):f+=n.substring(m),f}(n)}catch(e){}if(n=function(e){if(!e||!angular.isString(e)||e.length<=0)return e;for(var t,n=/<([^>\/]+?)align=("([^"]+)"|'([^']+)')([^>]*)>/gi,a="",r=0;t=n.exec(e);){a+=e.substring(r,t.index),r=t.index+t[0].length;var o="<"+t[1]+t[5];/style=("([^"]+)"|'([^']+)')/gi.test(o)?o=o.replace(/style=("([^"]+)"|'([^']+)')/i,'style="$2$3 text-align:'+(t[3]||t[4])+';"'):o+=' style="text-align:'+(t[3]||t[4])+';"',a+=o+=">"}return a+e.substring(r)}(n))try{n=(n=(n=(n=(n=(n=n.replace(s,"")).replace(d,"")).replace(s,"")).replace(c,"")).replace(u,"")).replace(p,"")}catch(e){}var o;try{o=e(n),r&&(o=n)}catch(e){o=a||""}var f,m=o.match(/(<pre[^>]*>.*?<\/pre[^>]*>)/gi),g=o.replace(/(&#(9|10);)*/gi,""),h=/<pre[^>]*>.*?<\/pre[^>]*>/gi,v=0,y=0;for(o="";null!==(f=h.exec(g))&&v<m.length;)o+=g.substring(y,f.index)+m[v],y=f.index+f[0].length,v++;return o+g.substring(y)}}]).factory("taToolExecuteAction",["$q","$log",function(e,t){return function(n){void 0!==n&&(this.$editor=function(){return n});var a,r=e.defer(),o=r.promise,l=this.$editor();try{a=this.action(r,l.startAction()),o.finally(function(){l.endAction.call(l)})}catch(e){t.error(e)}(a||void 0===a)&&r.resolve()}}]),angular.module("textAngular.DOM",["textAngular.factories"]).factory("taExecCommand",["taSelection","taBrowserTag","$document",function(e,t,n){var a=function(t,n){var a,r,o=t.find("li");for(r=o.length-1;r>=0;r--)a=angular.element("<"+n+">"+o[r].innerHTML+"</"+n+">"),t.after(a);t.remove(),e.setSelectionToElementEnd(a[0])},r=function(n,a,r,o,l){var i,s,d,c,u,p=n.find("li");for(s=0;s<p.length;s++)if(p[s].outerHTML===a[0].outerHTML){u=s,s>0&&(d=p[s-1]),s+1<p.length&&(c=p[s+1]);break}var f="";if(o?f+="<"+l+">"+a[0].innerHTML+"</"+l+">":(f+="<"+t(r)+">",f+="<li>"+a[0].innerHTML+"</li>",f+="</"+t(r)+">"),i=angular.element(f),!d)return a.remove(),n.after(angular.element(n[0].outerHTML)),n.after(i),n.remove(),void e.setSelectionToElementEnd(i[0]);if(c){n.parent();var m="",g=n[0].nodeName.toLowerCase();for(m+="<"+g+">",s=0;s<u;s++)m+="<li>"+p[s].innerHTML+"</li>";m+="</"+g+">";var h="";for(h+="<"+g+">",s=u+1;s<p.length;s++)h+="<li>"+p[s].innerHTML+"</li>";h+="</"+g+">",n.after(angular.element(h)),n.after(i),n.after(angular.element(m)),n.remove(),e.setSelectionToElementEnd(i[0])}else a.remove(),n.after(i),e.setSelectionToElementEnd(i[0])},o=function(t){/(<br(|\/)>)$/i.test(t.innerHTML.trim())?e.setSelectionBeforeElement(angular.element(t).find("br")[0]):e.setSelectionToElementEnd(t)},l=function(e,t){var n=angular.element("<"+t+">"+e[0].innerHTML+"</"+t+">");e.after(n),e.remove(),o(n.find("li")[0])},i=function(e,n,a){for(var r="",l=0;l<e.length;l++)r+="<"+t("li")+">"+e[l].innerHTML+"</"+t("li")+">";var i=angular.element("<"+a+">"+r+"</"+a+">");n.after(i),n.remove(),o(i.find("li")[0])},s=function(e,t){for(var n=0;n<e.childNodes.length;n++){var a=e.childNodes[n];a.tagName&&a.tagName.match(BLOCKELEMENTS)&&s(a,t)}if(null===e.parentNode)return e;if("<br>"===t)return e;var r=angular.element(t);return r[0].innerHTML=e.innerHTML,e.parentNode.insertBefore(r[0],e),e.parentNode.removeChild(e),r};return function(o,d){return o=t(o),function(c,u,p,f){var m,g,h,v,y,E,b,x,S=angular.element("<"+o+">");try{var T,w;e.getSelection&&(x=e.getSelection()),void 0!==(b=e.getSelectionElement()).tagName&&("div"===b.tagName.toLowerCase()&&/taTextElement.+/.test(b.id)&&x&&x.start&&1===x.start.offset&&1===x.end.offset?(T=b.innerHTML,/<br>/i.test(T)&&(T=T.replace(/<br>/i,"&#8203;")),/<br\/>/i.test(T)&&(T=T.replace(/<br\/>/i,"&#8203;")),/<span>(<span>)+/i.test(T)&&(T=__.replace(/<span>(<span>)+/i,"<span>")),/<\/span>(<\/span>)+/i.test(T)&&(T=__.replace(/<\/span>(<\/span>)+/i,"</span>")),/<span><\/span>/i.test(T)&&(T=T.replace(/<span><\/span>/i,"")),w="<div>"+T+"</div>",b.innerHTML=w,e.setSelectionToElementEnd(b.childNodes[0]),b=e.getSelectionElement()):"span"===b.tagName.toLowerCase()&&x&&x.start&&1===x.start.offset&&1===x.end.offset?(T=b.innerHTML,/<br>/i.test(T)&&(T=T.replace(/<br>/i,"&#8203;")),/<br\/>/i.test(T)&&(T=T.replace(/<br\/>/i,"&#8203;")),/<span>(<span>)+/i.test(T)&&(T=__.replace(/<span>(<span>)+/i,"<span>")),/<\/span>(<\/span>)+/i.test(T)&&(T=__.replace(/<\/span>(<\/span>)+/i,"</span>")),/<span><\/span>/i.test(T)&&(T=T.replace(/<span><\/span>/i,"")),w="<div>"+T+"</div>",b.innerHTML=w,e.setSelectionToElementEnd(b.childNodes[0]),b=e.getSelectionElement()):"p"===b.tagName.toLowerCase()&&x&&x.start&&1===x.start.offset&&1===x.end.offset?(T=b.innerHTML,/<br>/i.test(T)&&(T=T.replace(/<br>/i,"&#8203;"),b.innerHTML=T)):"li"===b.tagName.toLowerCase()&&x&&x.start&&x.start.offset===x.end.offset&&(T=b.innerHTML,/<br>/i.test(T)&&(T=T.replace(/<br>/i,""),b.innerHTML=T)))}catch(e){}if(b){var C=angular.element(b),N=b&&b.tagName&&b.tagName.toLowerCase()||"";if("insertorderedlist"===c.toLowerCase()||"insertunorderedlist"===c.toLowerCase()){var L=t("insertorderedlist"===c.toLowerCase()?"ol":"ul"),M=e.getOnlySelectedElements();if(M.length>1&&("ol"===N||"ul"===N))return function(n,a,r,o,l){var i,s,d,c,u,p=n.find("li"),f=[];for(s=0;s<p.length;s++)for(d=0;d<a.length;d++)p[s].isEqualNode(a[d])&&(f[d]=s);f[0]>0&&(c=p[f[0]-1]),f[a.length-1]+1<p.length&&(u=p[f[a.length-1]+1]);var m="";if(o)for(d=0;d<a.length;d++)m+="<"+l+">"+a[d].innerHTML+"</"+l+">",a[d].remove();else{for(m+="<"+t(r)+">",d=0;d<a.length;d++)m+=a[d].outerHTML,a[d].remove();m+="</"+t(r)+">"}if(i=angular.element(m),!c)return n.after(angular.element(n[0].outerHTML)),n.after(i),n.remove(),void e.setSelectionToElementEnd(i[0]);if(!u)return n.after(i),void e.setSelectionToElementEnd(i[0]);var g="",h=n[0].nodeName.toLowerCase();for(g+="<"+h+">",s=0;s<f[0];s++)g+="<li>"+p[s].innerHTML+"</li>";g+="</"+h+">";var v="";for(v+="<"+h+">",s=f[a.length-1]+1;s<p.length;s++)v+="<li>"+p[s].innerHTML+"</li>";v+="</"+h+">",n.after(angular.element(v)),n.after(i),n.after(angular.element(g)),n.remove(),e.setSelectionToElementEnd(i[0])}(C,M,L,L===N,o);if(N===L)return C[0].childNodes.length!==M.length&&1===M.length?(C=angular.element(M[0]),r(C.parent(),C,L,!0,o)):a(C,o);if("li"===N&&C.parent()[0].tagName.toLowerCase()===L&&1===C.parent().children().length)return a(C.parent(),o);if("li"===N&&C.parent()[0].tagName.toLowerCase()!==L&&1===C.parent().children().length)return l(C.parent(),L);if(N.match(BLOCKELEMENTS)&&!C.hasClass("ta-bind")){if(M.length&&C[0].childNodes.length!==M.length&&1===M.length)return C=angular.element(M[0]),r(C.parent(),C,L,L===N,o);if("ol"===N||"ul"===N)return l(C,L);var $=!1;return angular.forEach(C.children(),function(e){e.tagName.match(BLOCKELEMENTS)&&($=!0)}),i($?C.children():[angular.element("<div>"+b.innerHTML+"</div>")[0]],C,L)}if(N.match(BLOCKELEMENTS)){if(0===(v=e.getOnlySelectedElements()).length)g=angular.element("<"+L+"><li>"+b.innerHTML+"</li></"+L+">"),C.html(""),C.append(g);else{if(1===v.length&&("ol"===v[0].tagName.toLowerCase()||"ul"===v[0].tagName.toLowerCase()))return v[0].tagName.toLowerCase()===L?a(angular.element(v[0]),o):l(angular.element(v[0]),L);h="";var A=[];for(m=0;m<v.length;m++)if(3!==v[m].nodeType){var D=angular.element(v[m]);if("li"===v[m].tagName.toLowerCase())continue;"ol"===v[m].tagName.toLowerCase()||"ul"===v[m].tagName.toLowerCase()?h+=D[0].innerHTML:"span"!==v[m].tagName.toLowerCase()||"ol"!==v[m].childNodes[0].tagName.toLowerCase()&&"ul"!==v[m].childNodes[0].tagName.toLowerCase()?h+="<"+t("li")+">"+D[0].innerHTML+"</"+t("li")+">":h+=D[0].childNodes[0].innerHTML,A.unshift(D)}g=angular.element("<"+L+">"+h+"</"+L+">"),A.pop().replaceWith(g),angular.forEach(A,function(e){e.remove()})}return void e.setSelectionToElementEnd(g[0])}}else{if("formatblock"===c.toLowerCase()){for("default"===(E=p.toLowerCase().replace(/[<>]/gi,"")).trim()&&(E=o,p="<"+o+">"),g="li"===N?C.parent():C;!g[0].tagName||!g[0].tagName.match(BLOCKELEMENTS)&&!g.parent().attr("contenteditable");)N=((g=g.parent())[0].tagName||"").toLowerCase();if(N===E){v=g.children();var H=!1;for(m=0;m<v.length;m++)H=H||v[m].tagName.match(BLOCKELEMENTS);H?(g.after(v),y=g.next(),g.remove(),g=y):(S.append(g[0].childNodes),g.after(S),g.remove(),g=S)}else if(g.parent()[0].tagName.toLowerCase()!==E||g.parent().hasClass("ta-bind"))if(N.match(LISTELEMENTS))g.wrap(p);else{for(0===(v=e.getOnlySelectedElements()).length&&(v=[g[0]]),m=0;m<v.length;m++)if(3===v[m].nodeType||!v[m].tagName.match(BLOCKELEMENTS))for(;3===v[m].nodeType||!v[m].tagName||!v[m].tagName.match(BLOCKELEMENTS);)v[m]=v[m].parentNode;if((v=v.filter(function(e,t,n){return n.indexOf(e)===t})).length>1&&(v=v.filter(function(e,t,n){return!("div"===e.nodeName.toLowerCase()&&/^taTextElement/.test(e.id))})),angular.element(v[0]).hasClass("ta-bind"))(g=angular.element(p))[0].innerHTML=v[0].innerHTML,v[0].innerHTML=g[0].outerHTML;else if("blockquote"===E){for(h="",m=0;m<v.length;m++)h+=v[m].outerHTML;for((g=angular.element(p))[0].innerHTML=h,v[0].parentNode.insertBefore(g[0],v[0]),m=v.length-1;m>=0;m--)v[m].parentNode&&v[m].parentNode.removeChild(v[m])}else if("pre"===E&&e.getStateShiftKey()){for(h="",m=0;m<v.length;m++)h+=v[m].outerHTML;for((g=angular.element(p))[0].innerHTML=h,v[0].parentNode.insertBefore(g[0],v[0]),m=v.length-1;m>=0;m--)v[m].parentNode&&v[m].parentNode.removeChild(v[m])}else for(m=0;m<v.length;m++){var _=s(v[m],p);v[m]===g[0]&&(g=angular.element(_))}}else{var k=g.parent(),K=k.contents();for(m=0;m<K.length;m++)k.parent().hasClass("ta-bind")&&3===K[m].nodeType&&((S=angular.element("<"+o+">"))[0].innerHTML=K[m].outerHTML,K[m]=S[0]),k.parent()[0].insertBefore(K[m],k[0]);k.remove()}return e.setSelectionToElementEnd(g[0]),void g[0].focus()}if("createlink"===c.toLowerCase()){if("a"===N)return void(e.getSelectionElement().href=p);var B='<a href="'+p+'" target="'+(f.a.target?f.a.target:"")+'">';if(e.getSelection().collapsed)e.insertHtml(B+p+"</a>",d);else if(rangy.getSelection().getRangeAt(0).canSurroundContents()){var R=angular.element(B+"</a>")[0];rangy.getSelection().getRangeAt(0).surroundContents(R)}return}if("inserthtml"===c.toLowerCase())return void e.insertHtml(p,d)}try{n[0].execCommand(c,u,p)}catch(e){}}}}}]).service("taSelection",["$document","taDOM","$log",function(e,t,n){var a,r=e[0],o=function(e,t){return e.tagName&&e.tagName.match(/^br$/i)&&0===t&&!e.previousSibling?{element:e.parentNode,offset:0}:{element:e,offset:t}},l={getSelection:function(){var e;try{e=rangy.getSelection().getRangeAt(0)}catch(e){return}var t=e.commonAncestorContainer,n={start:o(e.startContainer,e.startOffset),end:o(e.endContainer,e.endOffset),collapsed:e.collapsed};return 3===t.nodeType&&("div"===t.parentNode.nodeName.toLowerCase()&&/^taTextElement/.test(t.parentNode.id)||(t=t.parentNode)),"div"===t.nodeName.toLowerCase()&&/^taTextElement/.test(t.id)?(n.start.element=t.childNodes[n.start.offset],n.end.element=t.childNodes[n.end.offset],n.container=t):t.parentNode===n.start.element||t.parentNode===n.end.element?n.container=t.parentNode:n.container=t,n},updateLeftArrowKey:function(e){var t=rangy.getSelection().getRangeAt(0);if(t&&t.collapsed){var n=l.getFlattenedDom(t);if(!n.findIndex)return;var a,r,o=t.startContainer,i=n.findIndex(function(e,t){return e.node===o||-1!==e.parents.indexOf(o)});if(n.forEach(function(e,t){e.parents.forEach(function(e,t){})}),i+1<n.length&&(a=n[i+1].node),a&&a.textContent&&/^\ufeff([^\ufeff]*)$/.exec(a.textContent))return;if(i>0&&(r=n[i-1].node),0===t.startOffset&&r&&/^\ufeff([^\ufeff]*)$/.exec(r.textContent))return void l.setSelectionToElementEnd(r)}},updateRightArrowKey:function(e){},getFlattenedDom:function(e){var t=e.commonAncestorContainer.parentNode;if(!t)return e.commonAncestorContainer.childNodes;var n=Array.prototype.slice.call(t.childNodes),a=n.indexOf(e.startContainer);return a+1<n.length&&a>0||t.parentNode&&(t=t.parentNode),n=[],function e(t){t.node.childNodes.length?Array.prototype.slice.call(t.node.childNodes).forEach(function(n){var a=t.parents.slice();a.slice(-1)[0]!==t.node&&a.push(t.node),e({parents:a,node:n})}):n.push({parents:t.parents,node:t.node})}({parents:[t],node:t}),n},getOnlySelectedElements:function(){var e=rangy.getSelection().getRangeAt(0),t=e.commonAncestorContainer;return t=3===t.nodeType?t.parentNode:t,e.getNodes([1],function(e){return e.parentNode===t})},getAllSelectedElements:function(){var e=rangy.getSelection().getRangeAt(0),t=e.commonAncestorContainer;t=3===t.nodeType?t.parentNode:t;var n=e.getNodes([1],function(e){return e.parentNode===t}),a=t.innerHTML;if((a=a.replace(/<span id=.selectionBoundary[^>]+>\ufeff?<\/span>/gi,""))===e.toHtml()&&("div"!==t.nodeName.toLowerCase()||!/^taTextElement/.test(t.id))){for(var r=[],o=n.length;o--;r.unshift(n[o]));(n=r).push(t)}return n},getSelectionElement:function(){return l.getSelection()?l.getSelection().container:void 0},setSelection:function(e,t,n,a){var r=rangy.createRange();r.setStart(e,n),r.setEnd(t,a),rangy.getSelection().setSingleRange(r)},setSelectionBeforeElement:function(e){var t=rangy.createRange();t.selectNode(e),t.collapse(!0),rangy.getSelection().setSingleRange(t)},setSelectionAfterElement:function(e){var t=rangy.createRange();t.selectNode(e),t.collapse(!1),rangy.getSelection().setSingleRange(t)},setSelectionToElementStart:function(e){var t=rangy.createRange();t.selectNodeContents(e),t.collapse(!0),rangy.getSelection().setSingleRange(t)},setSelectionToElementEnd:function(e){var t=rangy.createRange();t.selectNodeContents(e),t.collapse(!1),e.childNodes&&e.childNodes[e.childNodes.length-1]&&"br"===e.childNodes[e.childNodes.length-1].nodeName&&(t.startOffset=t.endOffset=t.startOffset-1),rangy.getSelection().setSingleRange(t)},setStateShiftKey:function(e){a=e},getStateShiftKey:function(){return a},insertHtml:function(e,n){var a,o,i,s,d,c,u,p=angular.element("<div>"+e+"</div>"),f=rangy.getSelection().getRangeAt(0),m=r.createDocumentFragment(),g=p[0].childNodes,h=!0;if(g.length>0){for(s=[],i=0;i<g.length;i++){var v=g[i];"p"===v.nodeName.toLowerCase()&&""===v.innerHTML.trim()||(h=h&&!BLOCKELEMENTS.test(v.nodeName),s.push(v))}for(var y=0;y<s.length;y++)c=m.appendChild(s[y]);!h&&f.collapsed&&/^(|<br(|\/)>)$/i.test(f.startContainer.innerHTML)&&f.selectNode(f.startContainer)}else h=!0,c=m=r.createTextNode(e);if(h)f.deleteContents();else if(f.collapsed&&f.startContainer!==n)if(f.startContainer.innerHTML&&f.startContainer.innerHTML.match(/^<[^>]*>$/i))a=f.startContainer,1===f.startOffset?(f.setStartAfter(a),f.setEndAfter(a)):(f.setStartBefore(a),f.setEndBefore(a));else{if(3===f.startContainer.nodeType&&f.startContainer.parentNode!==n)for(o=(a=f.startContainer.parentNode).cloneNode(),t.splitNodes(a.childNodes,a,o,f.startContainer,f.startOffset);!VALIDELEMENTS.test(a.nodeName);){angular.element(a).after(o);var E=o;o=(a=a.parentNode).cloneNode(),t.splitNodes(a.childNodes,a,o,E)}else o=(a=f.startContainer).cloneNode(),t.splitNodes(a.childNodes,a,o,void 0,void 0,f.startOffset);if(angular.element(a).after(o),f.setStartAfter(a),f.setEndAfter(a),/^(|<br(|\/)>)$/i.test(a.innerHTML.trim())&&(f.setStartBefore(a),f.setEndBefore(a),angular.element(a).remove()),/^(|<br(|\/)>)$/i.test(o.innerHTML.trim())&&angular.element(o).remove(),"li"===a.nodeName.toLowerCase()){for(u=r.createDocumentFragment(),d=0;d<m.childNodes.length;d++)p=angular.element("<li>"),t.transferChildNodes(m.childNodes[d],p[0]),t.transferNodeAttributes(m.childNodes[d],p[0]),u.appendChild(p[0]);m=u,c&&(c=(c=m.childNodes[m.childNodes.length-1]).childNodes[c.childNodes.length-1])}}else f.deleteContents();f.insertNode(m),c&&l.setSelectionToElementEnd(c)}};return l}]).service("taDOM",function(){var e={getByAttribute:function(t,n){var a=[],r=t.children();return r.length&&angular.forEach(r,function(t){a=a.concat(e.getByAttribute(angular.element(t),n))}),void 0!==t.attr(n)&&a.push(t),a},transferChildNodes:function(e,t){for(t.innerHTML="";e.childNodes.length>0;)t.appendChild(e.childNodes[0]);return t},splitNodes:function(t,n,a,r,o,l){if(!r&&isNaN(l))throw new Error("taDOM.splitNodes requires a splitNode or splitIndex");for(var i=document.createDocumentFragment(),s=document.createDocumentFragment(),d=0;t.length>0&&(isNaN(l)||l!==d)&&t[0]!==r;)i.appendChild(t[0]),d++;for(!isNaN(o)&&o>=0&&t[0]&&(i.appendChild(document.createTextNode(t[0].nodeValue.substring(0,o))),t[0].nodeValue=t[0].nodeValue.substring(o));t.length>0;)s.appendChild(t[0]);e.transferChildNodes(i,n),e.transferChildNodes(s,a)},transferNodeAttributes:function(e,t){for(var n=0;n<e.attributes.length;n++)t.setAttribute(e.attributes[n].name,e.attributes[n].value);return t}};return e}),angular.module("textAngular.validators",[]).directive("taMaxText",function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,a){var r=parseInt(e.$eval(n.taMaxText));if(isNaN(r))throw"Max text must be an integer";n.$observe("taMaxText",function(e){if(r=parseInt(e),isNaN(r))throw"Max text must be an integer";a.$dirty&&a.$validate()}),a.$validators.taMaxText=function(e){var t=angular.element("<div/>");return t.html(e),t.text().length<=r}}}}).directive("taMinText",function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,a){var r=parseInt(e.$eval(n.taMinText));if(isNaN(r))throw"Min text must be an integer";n.$observe("taMinText",function(e){if(r=parseInt(e),isNaN(r))throw"Min text must be an integer";a.$dirty&&a.$validate()}),a.$validators.taMinText=function(e){var t=angular.element("<div/>");return t.html(e),!t.text().length||t.text().length>=r}}}}),angular.module("textAngular.taBind",["textAngular.factories","textAngular.DOM"]).service("_taBlankTest",[function(){return function(e){return!e||""===stripHtmlToText(e)&&!/<img[^>]+>/.test(e)}}]).directive("taButton",[function(){return{link:function(e,t,n){t.attr("unselectable","on"),t.on("mousedown",function(e,t){return t&&angular.extend(e,t),e.preventDefault(),!1})}}}]).directive("taBind",["taSanitize","$timeout","$document","taFixChrome","taBrowserTag","taSelection","taSelectableElements","taApplyCustomRenderers","taOptions","_taBlankTest","$parse","taDOM","textAngularManager",function(e,t,n,a,r,o,l,i,s,d,c,u,p){return{priority:2,require:["ngModel","?ngModelOptions"],link:function(r,u,f,m){var g,h,v,y=m[0],E=m[1]||{},b=void 0!==u.attr("contenteditable")&&u.attr("contenteditable"),x=b||"textarea"===u[0].tagName.toLowerCase()||"input"===u[0].tagName.toLowerCase(),S=!1,T=!1,w=!1,C=f.taUnsafeSanitizer||s.disableSanitizer,N=f.taKeepStyles||s.keepStyles,L=/^(9|19|20|27|33|34|35|36|37|38|39|40|45|112|113|114|115|116|117|118|119|120|121|122|123|144|145)$/i,M=/^(8|13|32|46|59|61|107|109|173|186|187|188|189|190|191|192|219|220|221|222)$/i,$=1,A=2,D=4,H=8,_=[{specialKey:"UndoKey",forbiddenModifiers:D+H,mustHaveModifiers:[A+$],keyCode:90},{specialKey:"RedoKey",forbiddenModifiers:D,mustHaveModifiers:[A+$,H],keyCode:90},{specialKey:"RedoKey",forbiddenModifiers:D+H,mustHaveModifiers:[A+$],keyCode:89},{specialKey:"TabKey",forbiddenModifiers:A+H+D+$,mustHaveModifiers:[],keyCode:9},{specialKey:"ShiftTabKey",forbiddenModifiers:A+D+$,mustHaveModifiers:[H],keyCode:9}];void 0===f.taDefaultWrap&&(f.taDefaultWrap="p"),""===f.taDefaultWrap?(v="",void 0===_browserDetect.ie||(_browserDetect.ie>=11||_browserDetect.ie)):(v=void 0===_browserDetect.ie||_browserDetect.ie>=11?"br"===f.taDefaultWrap.toLowerCase()?"<BR><BR>":"<"+f.taDefaultWrap+"><br></"+f.taDefaultWrap+">":_browserDetect.ie<=8?"<"+f.taDefaultWrap.toUpperCase()+"></"+f.taDefaultWrap.toUpperCase()+">":"<"+f.taDefaultWrap+"></"+f.taDefaultWrap+">",void 0===_browserDetect.ie||_browserDetect.ie>=11?"br"===f.taDefaultWrap.toLowerCase()||(f.taDefaultWrap,f.taDefaultWrap):_browserDetect.ie<=8?(f.taDefaultWrap.toUpperCase(),f.taDefaultWrap.toUpperCase()):(f.taDefaultWrap,f.taDefaultWrap)),E.$options||(E.$options={});var k,K=function(e){if(d(e))return e;var t=angular.element("<div>"+e+"</div>");if(0===t.children().length)e="<"+f.taDefaultWrap+">"+e+"</"+f.taDefaultWrap+">";else{var n,a=t[0].childNodes,r=!1;for(n=0;n<a.length&&!(r=a[n].nodeName.toLowerCase().match(BLOCKELEMENTS));n++);if(r)for(e="",n=0;n<a.length;n++){var o=a[n],l=o.nodeName.toLowerCase();if("#comment"===l)e+="\x3c!--"+o.nodeValue+"--\x3e";else if("#text"===l){var i=o.textContent;i.trim()?e+="<"+f.taDefaultWrap+">"+i+"</"+f.taDefaultWrap+">":e+=i}else if(l.match(BLOCKELEMENTS))e+=o.outerHTML;else{var s=o.outerHTML||o.nodeValue;""!==s.trim()?e+="<"+f.taDefaultWrap+">"+s+"</"+f.taDefaultWrap+">":e+=s}}else e="<"+f.taDefaultWrap+">"+e+"</"+f.taDefaultWrap+">"}return e};f.taPaste&&(h=c(f.taPaste)),u.addClass("ta-bind"),r["$undoManager"+(f.id||"")]=y.$undoManager={_stack:[],_index:0,_max:1e3,push:function(e){return null==e||void 0!==this.current()&&null!==this.current()&&e===this.current()?e:(this._index<this._stack.length-1&&(this._stack=this._stack.slice(0,this._index+1)),this._stack.push(e),k&&t.cancel(k),this._stack.length>this._max&&this._stack.shift(),this._index=this._stack.length-1,e)},undo:function(){return this.setToIndex(this._index-1)},redo:function(){return this.setToIndex(this._index+1)},setToIndex:function(e){if(!(e<0||e>this._stack.length-1))return this._index=e,this.current()},current:function(){return this._stack[this._index]}};var B,R=function(){if(b)return u[0].innerHTML;if(x)return u.val();throw"textAngular Error: attempting to update non-editable taBind"},W=function(e){return r.$emit("ta-element-select",this),e.preventDefault(),!1},z=r["reApplyOnSelectorHandlers"+(f.id||"")]=function(){S||angular.forEach(l,function(e){u.find(e).off("click",W).on("click",W)})},O=function(e,t,n){w=n||!1,null==t&&(t=b),null==e&&(e=R()),d(e)?(""!==y.$viewValue&&y.$setViewValue(""),t&&""!==y.$undoManager.current()&&y.$undoManager.push("")):(z(),y.$viewValue!==e&&(y.$setViewValue(e),t&&y.$undoManager.push(e))),y.$render()},V=function(e){u[0].innerHTML=e},I=r["$undoTaBind"+(f.id||"")]=function(){if(!S&&b){var e=y.$undoManager.undo();null!=e&&(V(e),O(e,!1),B&&t.cancel(B),B=t(function(){u[0].focus(),o.setSelectionToElementEnd(u[0])},1))}},F=r["$redoTaBind"+(f.id||"")]=function(){if(!S&&b){var e=y.$undoManager.redo();null!=e&&(V(e),O(e,!1),B&&t.cancel(B),B=t(function(){u[0].focus(),o.setSelectionToElementEnd(u[0])},1))}};r["updateTaBind"+(f.id||"")]=function(){S||O(void 0,void 0,!0)};var q=function(t){return y.$oldViewValue=e(a(t,N),y.$oldViewValue,C)};if(u.attr("required")&&(y.$validators.required=function(e,t){return!d(e||t)}),y.$parsers.push(q),y.$parsers.unshift(K),y.$formatters.push(q),y.$formatters.unshift(K),y.$formatters.unshift(function(e){return y.$undoManager.push(e||"")}),x)if(r.events={},b){var U,P,G=!1,X=function(n){var a=void 0!==n&&n.match(/content=["']*OneNote.File/i);if(n&&n.trim().length){if(n.match(/class=["']*Mso(Normal|List)/i)||n.match(/content=["']*Word.Document/i)||n.match(/content=["']*OneNote.File/i)){var l=n.match(/<!--StartFragment-->([\s\S]*?)<!--EndFragment-->/i);l=(l=l?l[1]:n).replace(/<o:p>[\s\S]*?<\/o:p>/gi,"").replace(/class=(["']|)MsoNormal(["']|)/gi,"");var i=angular.element("<div>"+l+"</div>"),s=angular.element("<div></div>"),d={element:null,lastIndent:[],lastLi:null,isUl:!1};d.lastIndent.peek=function(){var e=this.length;if(e>0)return this[e-1]};for(var c=function(e){d.isUl=e,d.element=angular.element(e?"<ul>":"<ol>"),d.lastIndent=[],d.lastIndent.peek=function(){var e=this.length;if(e>0)return this[e-1]},d.lastLevelMatch=null},p=0;p<=i[0].childNodes.length;p++)if(i[0].childNodes[p]&&"#text"!==i[0].childNodes[p].nodeName){var f=i[0].childNodes[p].tagName.toLowerCase();if("p"===f||"ul"===f||"h1"===f||"h2"===f||"h3"===f||"h4"===f||"h5"===f||"h6"===f||"table"===f||"span"===f){var m=angular.element(i[0].childNodes[p]),g=(m.attr("class")||"").match(/MsoList(Bullet|Number|Paragraph)(CxSp(First|Middle|Last)|)/i);if(g){if(m[0].childNodes.length<2||m[0].childNodes[1].childNodes.length<1)continue;var v="bullet"===g[1].toLowerCase()||"number"!==g[1].toLowerCase()&&!(/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(m[0].childNodes[1].innerHTML)||/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(m[0].childNodes[1].childNodes[0].innerHTML)),E=(m.attr("style")||"").match(/margin-left:([\-\.0-9]*)/i),b=parseFloat(E?E[1]:0),x=(m.attr("style")||"").match(/mso-list:l([0-9]+) level([0-9]+) lfo[0-9+]($|;)/i);if(x&&x[2]&&(b=parseInt(x[2])),x&&(!d.lastLevelMatch||x[1]!==d.lastLevelMatch[1])||!g[3]||"first"===g[3].toLowerCase()||null===d.lastIndent.peek()||d.isUl!==v&&d.lastIndent.peek()===b)c(v),s.append(d.element);else if(null!=d.lastIndent.peek()&&d.lastIndent.peek()<b)d.element=angular.element(v?"<ul>":"<ol>"),d.lastLi.append(d.element);else if(null!=d.lastIndent.peek()&&d.lastIndent.peek()>b){for(;null!=d.lastIndent.peek()&&d.lastIndent.peek()>b;)if("li"!==d.element.parent()[0].tagName.toLowerCase()){if(!/[uo]l/i.test(d.element.parent()[0].tagName.toLowerCase()))break;d.element=d.element.parent(),d.lastIndent.pop()}else d.element=d.element.parent();d.isUl="ul"===d.element[0].tagName.toLowerCase(),v!==d.isUl&&(c(v),s.append(d.element))}d.lastLevelMatch=x,b!==d.lastIndent.peek()&&d.lastIndent.push(b),d.lastLi=angular.element("<li>"),d.element.append(d.lastLi),d.lastLi.html(m.html().replace(/<!(--|)\[if !supportLists\](--|)>[\s\S]*?<!(--|)\[endif\](--|)>/gi,"")),m.remove()}else c(!1),s.append(m)}}var S=function(e){for(var t=(e=angular.element(e))[0].childNodes.length-1;t>=0;t--)e.after(e[0].childNodes[t]);e.remove()};angular.forEach(s.find("span"),function(e){e.removeAttribute("lang"),e.attributes.length<=0&&S(e)}),angular.forEach(s.find("font"),S),n=s.html(),a&&(n=s.html()||i.html()),n=n.replace(/\n/g," ")}else{if((n=n.replace(/<(|\/)meta[^>]*?>/gi,"")).match(/<[^>]*?(ta-bind)[^>]*?>/)){if(n.match(/<[^>]*?(text-angular)[^>]*?>/)){var T=angular.element("<div>"+n+"</div>");T.find("textarea").remove();for(var w=0;w<binds.length;w++){for(var N=binds[w][0].parentNode.parentNode,L=0;L<binds[w][0].childNodes.length;L++)N.parentNode.insertBefore(binds[w][0].childNodes[L],N);N.parentNode.removeChild(N)}n=T.html().replace('<br class="Apple-interchange-newline">',"")}}else n.match(/^<span/)&&(n.match(/<span class=(\"Apple-converted-space\"|\'Apple-converted-space\')>.<\/span>/gi)||(n=n.replace(/<(|\/)span[^>]*?>/gi,"")));n=n.replace(/<br class="Apple-interchange-newline"[^>]*?>/gi,"").replace(/<span class="Apple-converted-space">( |&nbsp;)<\/span>/gi,"&nbsp;")}/<li(\s.*)?>/i.test(n)&&!1===/(<ul(\s.*)?>|<ol(\s.*)?>).*<li(\s.*)?>/i.test(n)&&(n=n.replace(/<li(\s.*)?>.*<\/li(\s.*)?>/i,"<ul>$&</ul>")),n=n.replace(/^[ |\u00A0]+/gm,function(e){for(var t="",n=0;n<e.length;n++)t+="&nbsp;";return t}).replace(/\n|\r\n|\r/g,"<br />").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;"),h&&(n=h(r,{$html:n})||n),n=n.replace(/<span style=("|')([^<]*?)vertical-align\s*:\s*super;?([^>]*?)("|')>([^<]+?)<\/span>/g,"<sup style='$2$3'>$5</sup>"),n=e(n,"",C),o.insertHtml(n,u[0]),t(function(){y.$setViewValue(R()),G=!1,u.removeClass("processing-paste")},0)}else G=!1,u.removeClass("processing-paste")};if(u.on("paste",r.events.paste=function(e,a){if(a&&angular.extend(e,a),S||G)return e.stopPropagation(),e.preventDefault(),!1;var r;G=!0,u.addClass("processing-paste");var o=(e.originalEvent||e).clipboardData;if(!o&&window.clipboardData&&window.clipboardData.getData)return r=window.clipboardData.getData("Text"),X(r),e.stopPropagation(),e.preventDefault(),!1;if(o&&o.getData&&o.types.length>0){for(var l="",i=0;i<o.types.length;i++)l+=" "+o.types[i];return/text\/html/i.test(l)?r=o.getData("text/html"):/text\/plain/i.test(l)&&(r=o.getData("text/plain")),X(r),e.stopPropagation(),e.preventDefault(),!1}var s=rangy.saveSelection(),d=angular.element('<div class="ta-hidden-input" contenteditable="true"></div>');n.find("body").append(d),d[0].focus(),t(function(){rangy.restoreSelection(s),X(d[0].innerHTML),u[0].focus(),d.remove()},0)}),u.on("cut",r.events.cut=function(e){S?e.preventDefault():t(function(){y.$setViewValue(R())},0)}),u.on("keydown",r.events.keydown=function(e,t){var n;if(t&&angular.extend(e,t),16===e.keyCode?o.setStateShiftKey(!0):o.setStateShiftKey(!1),e.specialKey=function(e){var t;return _.forEach(function(n){if(n.keyCode===e.keyCode){var a=(e.metaKey?A:0)+(e.ctrlKey?$:0)+(e.shiftKey?H:0)+(e.altKey?D:0);if(n.forbiddenModifiers&a)return;n.mustHaveModifiers.every(function(e){return a&e})&&(t=n.specialKey)}}),t}(e),s.keyMappings.forEach(function(t){e.specialKey===t.commandKeyCode&&(e.specialKey=void 0),t.testForKey(e)&&(n=t.commandKeyCode),"UndoKey"!==t.commandKeyCode&&"RedoKey"!==t.commandKeyCode||t.enablePropagation||e.preventDefault()}),void 0!==n&&(e.specialKey=n),void 0===e.specialKey||"UndoKey"===e.specialKey&&"RedoKey"===e.specialKey||(e.preventDefault(),p.sendKeyCommand(r,e)),!(S||("UndoKey"===e.specialKey&&(I(),e.preventDefault()),"RedoKey"===e.specialKey&&(F(),e.preventDefault()),13!==e.keyCode||e.shiftKey||e.ctrlKey||e.metaKey||e.altKey))){var a,l=o.getSelectionElement();if(!l.nodeName.match(VALIDELEMENTS))return;var i=angular.element(v);if(function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1}(["blockquote","ul","ol"],l.parentNode.tagName.toLowerCase())){if(/^<br(|\/)>$/i.test(l.innerHTML.trim())&&!l.nextSibling){var d=(a=angular.element(l)).parent();d.after(i),a.remove(),0===d.children().length&&d.remove(),o.setSelectionToElementStart(i[0]),e.preventDefault()}/^<[^>]+><br(|\/)><\/[^>]+>$/i.test(l.innerHTML.trim())&&((a=angular.element(l)).after(i),a.remove(),o.setSelectionToElementStart(i[0]),e.preventDefault())}}}),u.on("keyup",r.events.keyup=function(e,n){if(n&&angular.extend(e,n),o.setStateShiftKey(!1),9!==e.keyCode){if(37!==e.keyCode||e.shiftKey||o.updateLeftArrowKey(u),39!==e.keyCode||e.shiftKey||o.updateRightArrowKey(u),k&&t.cancel(k),!S&&!L.test(e.keyCode))if(13===e.keyCode&&(e.ctrlKey||e.metaKey||e.altKey));else{if(""!==v&&"<BR><BR>"!==v&&13===e.keyCode&&!e.ctrlKey&&!e.metaKey&&!e.altKey){for(var a=o.getSelectionElement();!a.nodeName.match(VALIDELEMENTS)&&a!==u[0];)a=a.parentNode;if(e.shiftKey){var r=a.tagName.toLowerCase();if((r===f.taDefaultWrap||"li"===r||"pre"===r||"div"===r)&&!/.+<br><br>/.test(a.innerHTML.trim())){var l=a.previousSibling;l&&(l.innerHTML=l.innerHTML+"<br><br>",angular.element(a).remove(),o.setSelectionToElementEnd(l))}}else if(a.tagName.toLowerCase()!==f.taDefaultWrap&&"li"!==a.nodeName.toLowerCase()&&(""===a.innerHTML.trim()||"<br>"===a.innerHTML.trim())){var i=angular.element(v);angular.element(a).replaceWith(i),o.setSelectionToElementStart(i[0])}}var s=R();""===v||""!==s.trim()&&"<br>"!==s.trim()?"<"!==s.substring(0,1)&&f.taDefaultWrap:(V(v),o.setSelectionToElementStart(u.children()[0]));var d=g!==e.keyCode&&M.test(e.keyCode);U&&t.cancel(U),U=t(function(){O(s,d,!0)},E.$options.debounce||400),d||(k=t(function(){y.$undoManager.push(s)},250)),g=e.keyCode}}else o.getSelection().start.element===u[0]&&u.children().length&&o.setSelectionToElementStart(u.children()[0])}),u.on("input",function(){R()!==y.$viewValue&&(P&&t.cancel(P),P=t(function(){var e=rangy.saveSelection(),t=R();t!==y.$viewValue&&O(t,!0),0!==y.$viewValue.length&&rangy.restoreSelection(e)},1e3))}),u.on("blur",r.events.blur=function(){T=!1,S?(w=!0,y.$render()):O(void 0,void 0,!0)}),f.placeholder&&(_browserDetect.ie>8||void 0===_browserDetect.ie)){var Y;if(!f.id)throw"textAngular Error: An unique ID is required for placeholders to work";Y=addCSSRule("#"+f.id+".placeholder-text:before",'content: "'+f.placeholder+'"'),r.$on("$destroy",function(){removeCSSRule(Y)})}u.on("focus",r.events.focus=function(){T=!0,u.removeClass("placeholder-text"),z()}),u.on("mouseup",r.events.mouseup=function(){var e=o.getSelection();e&&e.start.element===u[0]&&u.children().length&&o.setSelectionToElementStart(u.children()[0])}),u.on("mousedown",r.events.mousedown=function(e,t){t&&angular.extend(e,t),e.stopPropagation()})}else{u.on("change blur",r.events.change=r.events.blur=function(){S||y.$setViewValue(R())}),u.on("keydown",r.events.keydown=function(e,t){if(t&&angular.extend(e,t),9===e.keyCode){var n=this.selectionStart,a=this.selectionEnd,r=u.val();if(e.shiftKey){var o=r.lastIndexOf("\n",n),l=r.lastIndexOf("\t",n);-1!==l&&l>=o&&(u.val(r.substring(0,l)+r.substring(l+1)),this.selectionStart=this.selectionEnd=n-1)}else u.val(r.substring(0,n)+"\t"+r.substring(a)),this.selectionStart=this.selectionEnd=n+1;e.preventDefault()}});var j=function(e,t){for(var n="",a=0;a<t;a++)n+=e;return n},J=function(e,t,n){for(var a=0;a<e.length;a++)t.call(n,a,e[a])},Q=function(e,t){var n="",a=e.childNodes;return n+=j("\t",++t-1)+e.outerHTML.substring(0,4),J(a,function(e,a){var r=a.nodeName.toLowerCase();"#comment"!==r?"#text"!==r?a.outerHTML&&(n+="ul"===r||"ol"===r?"\n"+Q(a,t):"\n"+j("\t",t)+a.outerHTML):n+=a.textContent:n+="\x3c!--"+a.nodeValue+"--\x3e"}),n+="\n"+j("\t",t-1)+e.outerHTML.substring(e.outerHTML.lastIndexOf("<"))};y.$formatters.unshift(function(e){var t=angular.element("<div>"+e+"</div>")[0].childNodes;return t.length>0&&(e="",J(t,function(t,n){var a=n.nodeName.toLowerCase();"#comment"!==a?"#text"!==a?n.outerHTML&&(e.length>0&&(e+="\n"),e+="ul"===a||"ol"===a?""+Q(n,0):""+n.outerHTML):e+=n.textContent:e+="\x3c!--"+n.nodeValue+"--\x3e"})),e})}var Z,ee=function(e,n){var a;(n&&angular.extend(e,n),dropFired||S)||(dropFired=!0,a=e.originalEvent?e.originalEvent.dataTransfer:e.dataTransfer,r.$emit("ta-drop-event",this,e,a),t(function(){dropFired=!1,O(void 0,void 0,!0)},100))},te=!1;y.$render=function(){if(!te){te=!0;var e=y.$viewValue||"";w||(b&&T&&(u.removeClass("placeholder-text"),Z&&t.cancel(Z),Z=t(function(){T||(u[0].focus(),o.setSelectionToElementEnd(u.children()[u.children().length-1])),Z=void 0},1)),b?(f.placeholder,V(""===e?v:e),S?u.off("drop",ee):(z(),u.on("drop",ee))):"textarea"!==u[0].tagName.toLowerCase()&&"input"!==u[0].tagName.toLowerCase()?V(i(e)):u.val(e)),b&&f.placeholder&&(""===e?T?u.removeClass("placeholder-text"):u.addClass("placeholder-text"):u.removeClass("placeholder-text")),te=w=!1}},f.taReadonly&&((S=r.$eval(f.taReadonly))?(u.addClass("ta-readonly"),"textarea"!==u[0].tagName.toLowerCase()&&"input"!==u[0].tagName.toLowerCase()||u.attr("disabled","disabled"),void 0!==u.attr("contenteditable")&&u.attr("contenteditable")&&u.removeAttr("contenteditable")):(u.removeClass("ta-readonly"),"textarea"===u[0].tagName.toLowerCase()||"input"===u[0].tagName.toLowerCase()?u.removeAttr("disabled"):b&&u.attr("contenteditable","true")),r.$watch(f.taReadonly,function(e,t){t!==e&&(e?(u.addClass("ta-readonly"),"textarea"!==u[0].tagName.toLowerCase()&&"input"!==u[0].tagName.toLowerCase()||u.attr("disabled","disabled"),void 0!==u.attr("contenteditable")&&u.attr("contenteditable")&&u.removeAttr("contenteditable"),angular.forEach(l,function(e){u.find(e).on("click",W)}),u.off("drop",ee)):(u.removeClass("ta-readonly"),"textarea"===u[0].tagName.toLowerCase()||"input"===u[0].tagName.toLowerCase()?u.removeAttr("disabled"):b&&u.attr("contenteditable","true"),angular.forEach(l,function(e){u.find(e).off("click",W)}),u.on("drop",ee)),S=e)})),b&&!S&&(angular.forEach(l,function(e){u.find(e).on("click",W)}),u.on("drop",ee))}}}]);var dropFired=!1,textAngular=angular.module("textAngular",["ngSanitize","textAngularSetup","textAngular.factories","textAngular.DOM","textAngular.validators","textAngular.taBind"]);textAngular.config([function(){angular.forEach(taTools,function(e,t){delete taTools[t]})}]),textAngular.directive("textAngular",["$compile","$timeout","taOptions","taSelection","taExecCommand","textAngularManager","$document","$animate","$log","$q","$parse",function(e,t,n,a,r,o,l,i,s,d,c){return{require:"?ngModel",scope:{},restrict:"EA",priority:2,link:function(u,p,f,m){var g,h,v,y,E,b,x,S,T,w,C,N,L=f.serial?f.serial:Math.floor(1e16*Math.random());u._name=f.name?f.name:"textAngularEditor"+L;var M=function(e,n,a){t(function(){e.one(n,a)},100)};if(T=r(f.taDefaultWrap),angular.extend(u,angular.copy(n),{wrapSelection:function(e,t,n){"undo"===e.toLowerCase()?u["$undoTaBindtaTextElement"+L]():"redo"===e.toLowerCase()?u["$redoTaBindtaTextElement"+L]():(T(e,!1,t,u.defaultTagAttributes),n&&u["reApplyOnSelectorHandlerstaTextElement"+L](),u.displayElements.text[0].focus())},showHtml:u.$eval(f.taShowHtml)||!1}),f.taFocussedClass&&(u.classes.focussed=f.taFocussedClass),f.taTextEditorClass&&(u.classes.textEditor=f.taTextEditorClass),f.taHtmlEditorClass&&(u.classes.htmlEditor=f.taHtmlEditorClass),f.taDefaultTagAttributes)try{angular.extend(u.defaultTagAttributes,angular.fromJson(f.taDefaultTagAttributes))}catch(e){s.error(e)}f.taTextEditorSetup&&(u.setup.textEditorSetup=u.$parent.$eval(f.taTextEditorSetup)),f.taHtmlEditorSetup&&(u.setup.htmlEditorSetup=u.$parent.$eval(f.taHtmlEditorSetup)),f.taFileDrop?u.fileDropHandler=u.$parent.$eval(f.taFileDrop):u.fileDropHandler=u.defaultFileDropHandler,x=p[0].innerHTML,p[0].innerHTML="",u.displayElements={forminput:angular.element("<input type='hidden' tabindex='-1' style='display: none;'>"),html:angular.element("<textarea></textarea>"),text:angular.element("<div></div>"),scrollWindow:angular.element("<div class='ta-scroll-window'></div>"),popover:angular.element('<div class="popover fade bottom" style="max-width: none; width: 305px;"></div>'),popoverArrow:angular.element('<div class="arrow"></div>'),popoverContainer:angular.element('<div class="popover-content"></div>'),resize:{overlay:angular.element('<div class="ta-resizer-handle-overlay"></div>'),background:angular.element('<div class="ta-resizer-handle-background"></div>'),anchors:[angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-tl"></div>'),angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-tr"></div>'),angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-bl"></div>'),angular.element('<div class="ta-resizer-handle-corner ta-resizer-handle-corner-br"></div>')],info:angular.element('<div class="ta-resizer-handle-info"></div>')}},u.displayElements.popover.append(u.displayElements.popoverArrow),u.displayElements.popover.append(u.displayElements.popoverContainer),u.displayElements.scrollWindow.append(u.displayElements.popover),u.displayElements.popover.on("mousedown",function(e,t){return t&&angular.extend(e,t),e.preventDefault(),!1}),u.handlePopoverEvents=function(){"block"===u.displayElements.popover.css("display")&&(N&&t.cancel(N),N=t(function(){u.reflowPopover(u.resizeElement),u.reflowResizeOverlay(u.resizeElement)},100))},angular.element(window).on("resize",u.handlePopoverEvents),angular.element(window).on("scroll",u.handlePopoverEvents);u.getScrollTop=function(e,t){var n=e.scrollTop;return void 0===n&&(n=0),t&&function(e){var t,n={vertical:!1,horizontal:!1};try{if(null===(t=window.getComputedStyle(e)))return n}catch(e){return n}var a=t["overflow-y"],r=t["overflow-x"];return{vertical:("scroll"===a||"auto"===a)&&e.scrollHeight>e.clientHeight,horizontal:("scroll"===r||"auto"===r)&&e.scrollWidth>e.clientWidth}}(e).vertical&&(e.removeEventListener("scroll",u._scrollListener,!1),e.addEventListener("scroll",u._scrollListener,!1)),0!==n?{node:e.nodeName,top:n}:e.parentNode?u.getScrollTop(e.parentNode,t):{node:"<none>",top:0}},u.showPopover=function(e){u.getScrollTop(u.displayElements.scrollWindow[0],!0),u.displayElements.popover.css("display","block"),t(function(){u.displayElements.resize.overlay.css("display","block")}),u.resizeElement=e,u.reflowPopover(e),i.addClass(u.displayElements.popover,"in"),M(l.find("body"),"click keyup",function(){u.hidePopover()})},u._scrollListener=function(e,t){u.handlePopoverEvents()},u.reflowPopover=function(e){var t=u.getScrollTop(u.displayElements.scrollWindow[0],!1);e[0].offsetTop-t.top<51?(u.displayElements.popover.css("top",e[0].offsetTop+e[0].offsetHeight+u.displayElements.scrollWindow[0].scrollTop+"px"),u.displayElements.popover.removeClass("top").addClass("bottom")):(u.displayElements.popover.css("top",e[0].offsetTop-54+u.displayElements.scrollWindow[0].scrollTop+"px"),u.displayElements.popover.removeClass("bottom").addClass("top"));var n=u.displayElements.text[0].offsetWidth-u.displayElements.popover[0].offsetWidth,a=e[0].offsetLeft+e[0].offsetWidth/2-u.displayElements.popover[0].offsetWidth/2,r=Math.max(0,Math.min(n,a)),o=Math.min(a,Math.max(0,a-n))-11;r+=window.scrollX,o-=window.scrollX,u.displayElements.popover.css("left",r+"px"),u.displayElements.popoverArrow.css("margin-left",o+"px")},u.hidePopover=function(){u.displayElements.popover.css("display","none"),u.displayElements.popoverContainer.attr("style",""),u.displayElements.popoverContainer.attr("class","popover-content"),u.displayElements.popover.removeClass("in"),u.displayElements.resize.overlay.css("display","none")},u.displayElements.resize.overlay.append(u.displayElements.resize.background),angular.forEach(u.displayElements.resize.anchors,function(e){u.displayElements.resize.overlay.append(e)}),u.displayElements.resize.overlay.append(u.displayElements.resize.info),u.displayElements.scrollWindow.append(u.displayElements.resize.overlay),u.displayElements.resize.background.on("click",function(e){u.displayElements.text[0].focus()}),u.reflowResizeOverlay=function(e){e=angular.element(e)[0],u.displayElements.resize.overlay.css({display:"block",left:e.offsetLeft-5+"px",top:e.offsetTop-5+"px",width:e.offsetWidth+10+"px",height:e.offsetHeight+10+"px"}),u.displayElements.resize.info.text(e.offsetWidth+" x "+e.offsetHeight)},u.showResizeOverlay=function(e){var t=l.find("body");w=function(n){var a={width:parseInt(e.attr("width")),height:parseInt(e.attr("height")),x:n.clientX,y:n.clientY};(void 0===a.width||isNaN(a.width))&&(a.width=e[0].offsetWidth),(void 0===a.height||isNaN(a.height))&&(a.height=e[0].offsetHeight),u.hidePopover();var r=a.height/a.width,o=function(t){var n={x:Math.max(0,a.width+(t.clientX-a.x)),y:Math.max(0,a.height+(t.clientY-a.y))},o=void 0!==f.taResizeForceAspectRatio,l=f.taResizeMaintainAspectRatio;if(o||l&&!t.shiftKey){var i=n.y/n.x;n.x=r>i?n.x:n.y/r,n.y=r>i?n.x*r:n.y}var s=angular.element(e);function d(e){return Math.round(Math.max(0,e))}s.css("height",d(n.y)+"px"),s.css("width",d(n.x)+"px"),u.reflowResizeOverlay(e)};t.on("mousemove",o),M(t,"mouseup",function(e){e.preventDefault(),e.stopPropagation(),t.off("mousemove",o),u.$apply(function(){u.hidePopover(),u.updateTaBindtaTextElement()},100)}),n.stopPropagation(),n.preventDefault()},u.displayElements.resize.anchors[3].off("mousedown"),u.displayElements.resize.anchors[3].on("mousedown",w),u.reflowResizeOverlay(e),M(t,"click",function(){u.hideResizeOverlay()})},u.hideResizeOverlay=function(){u.displayElements.resize.anchors[3].off("mousedown",w),u.displayElements.resize.overlay.css("display","none")},u.setup.htmlEditorSetup(u.displayElements.html),u.setup.textEditorSetup(u.displayElements.text),u.displayElements.html.attr({id:"taHtmlElement"+L,"ng-show":"showHtml","ta-bind":"ta-bind","ng-model":"html","ng-model-options":p.attr("ng-model-options")}),u.displayElements.text.attr({id:"taTextElement"+L,contentEditable:"true","ta-bind":"ta-bind","ng-model":"html","ng-model-options":p.attr("ng-model-options")}),u.displayElements.scrollWindow.attr({"ng-hide":"showHtml"}),f.taDefaultWrap&&u.displayElements.text.attr("ta-default-wrap",f.taDefaultWrap),f.taUnsafeSanitizer&&(u.displayElements.text.attr("ta-unsafe-sanitizer",f.taUnsafeSanitizer),u.displayElements.html.attr("ta-unsafe-sanitizer",f.taUnsafeSanitizer)),f.taKeepStyles&&(u.displayElements.text.attr("ta-keep-styles",f.taKeepStyles),u.displayElements.html.attr("ta-keep-styles",f.taKeepStyles)),u.displayElements.scrollWindow.append(u.displayElements.text),p.append(u.displayElements.scrollWindow),p.append(u.displayElements.html),u.displayElements.forminput.attr("name",u._name),p.append(u.displayElements.forminput),f.tabindex&&(p.removeAttr("tabindex"),u.displayElements.text.attr("tabindex",f.tabindex),u.displayElements.html.attr("tabindex",f.tabindex)),f.placeholder&&(u.displayElements.text.attr("placeholder",f.placeholder),u.displayElements.html.attr("placeholder",f.placeholder)),f.taDisabled&&(u.displayElements.text.attr("ta-readonly","disabled"),u.displayElements.html.attr("ta-readonly","disabled"),u.disabled=u.$parent.$eval(f.taDisabled),u.$parent.$watch(f.taDisabled,function(e){u.disabled=e,u.disabled?p.addClass(u.classes.disabled):p.removeClass(u.classes.disabled)})),f.taPaste&&(u._pasteHandler=function(e){return c(f.taPaste)(u.$parent,{$html:e})},u.displayElements.text.attr("ta-paste","_pasteHandler($html)")),e(u.displayElements.scrollWindow)(u),e(u.displayElements.html)(u),u.updateTaBindtaTextElement=u["updateTaBindtaTextElement"+L],u.updateTaBindtaHtmlElement=u["updateTaBindtaHtmlElement"+L],p.addClass("ta-root"),u.displayElements.scrollWindow.addClass("ta-text ta-editor "+u.classes.textEditor),u.displayElements.html.addClass("ta-html ta-editor "+u.classes.htmlEditor);var $=function(e,t){t!==l[0].queryCommandState(e)&&l[0].execCommand(e,!1,null)};u._actionRunning=!1;var A=!1;if(u.startAction=function(){var e,t,n,a;return u._actionRunning=!0,e=l[0].queryCommandState("bold"),t=l[0].queryCommandState("italic"),n=l[0].queryCommandState("underline"),a=l[0].queryCommandState("strikeThrough"),A=rangy.saveSelection(),$("bold",e),$("italic",t),$("underline",n),$("strikeThrough",a),function(){A&&rangy.restoreSelection(A)}},u.endAction=function(){u._actionRunning=!1,A&&(u.showHtml?u.displayElements.html[0].focus():u.displayElements.text[0].focus(),rangy.removeMarkers(A)),A=!1,u.updateSelectedStyles(),u.showHtml||u["updateTaBindtaTextElement"+L]()},E=function(e){u.focussed=!0,p.addClass(u.classes.focussed),S.focus(),p.triggerHandler("focus"),u.updateSelectedStyles&&!u._bUpdateSelectedStyles&&t(function(){u.updateSelectedStyles()},0)},u.displayElements.html.on("focus",E),u.displayElements.text.on("focus",E),b=function(e){return u._actionRunning||l[0].activeElement===u.displayElements.html[0]||l[0].activeElement===u.displayElements.text[0]||(p.removeClass(u.classes.focussed),S.unfocus(),t(function(){u._bUpdateSelectedStyles=!1,p.triggerHandler("blur"),u.focussed=!1},0)),e.preventDefault(),!1},u.displayElements.html.on("blur",b),u.displayElements.text.on("blur",b),u.displayElements.text.on("paste",function(e){p.triggerHandler("paste",e)}),u.queryFormatBlockState=function(e){return!u.showHtml&&e.toLowerCase()===l[0].queryCommandValue("formatBlock").toLowerCase()},u.queryCommandState=function(e){return u.showHtml?"":l[0].queryCommandState(e)},u.switchView=function(){u.showHtml=!u.showHtml,i.enabled(!1,u.displayElements.html),i.enabled(!1,u.displayElements.text),u.showHtml?t(function(){return i.enabled(!0,u.displayElements.html),i.enabled(!0,u.displayElements.text),u.displayElements.html[0].focus()},100):t(function(){return i.enabled(!0,u.displayElements.html),i.enabled(!0,u.displayElements.text),u.displayElements.text[0].focus()},100)},f.ngModel){var D=!0;m.$render=function(){if(D){D=!1;var e=u.$parent.$eval(f.ngModel);null==e&&x&&""!==x&&m.$setViewValue(x)}u.displayElements.forminput.val(m.$viewValue),u.html=m.$viewValue||""},p.attr("required")&&(m.$validators.required=function(e,t){var n=e||t;return!(!n||""===n.trim())})}else u.displayElements.forminput.val(x),u.html=x;if(u.$watch("html",function(e,t){e!==t&&(f.ngModel&&m.$viewValue!==e&&m.$setViewValue(e),u.displayElements.forminput.val(e))}),f.taTargetToolbars)S=o.registerEditor(u._name,u,f.taTargetToolbars.split(","));else{var H=angular.element('<div text-angular-toolbar name="textAngularToolbar'+L+'">');f.taToolbar&&H.attr("ta-toolbar",f.taToolbar),f.taToolbarClass&&H.attr("ta-toolbar-class",f.taToolbarClass),f.taToolbarGroupClass&&H.attr("ta-toolbar-group-class",f.taToolbarGroupClass),f.taToolbarButtonClass&&H.attr("ta-toolbar-button-class",f.taToolbarButtonClass),f.taToolbarActiveButtonClass&&H.attr("ta-toolbar-active-button-class",f.taToolbarActiveButtonClass),f.taFocussedClass&&H.attr("ta-focussed-class",f.taFocussedClass),p.prepend(H),e(H)(u.$parent),S=o.registerEditor(u._name,u,["textAngularToolbar"+L])}u.$on("$destroy",function(){o.unregisterEditor(u._name),angular.element(window).off("blur"),angular.element(window).off("resize",u.handlePopoverEvents),angular.element(window).off("scroll",u.handlePopoverEvents)}),u.$on("ta-element-select",function(e,t){S.triggerElementSelect(e,t)&&u["reApplyOnSelectorHandlerstaTextElement"+L]()}),u.$on("ta-drop-event",function(e,n,r,o){o&&o.files&&o.files.length>0?(u.displayElements.text[0].focus(),a.setSelectionToElementEnd(r.target),angular.forEach(o.files,function(e){try{d.when(u.fileDropHandler(e,u.wrapSelection)||u.fileDropHandler!==u.defaultFileDropHandler&&d.when(u.defaultFileDropHandler(e,u.wrapSelection))).then(function(){u["updateTaBindtaTextElement"+L]()})}catch(e){s.error(e)}}),r.preventDefault(),r.stopPropagation()):t(function(){u["updateTaBindtaTextElement"+L]()},0)}),u._bUpdateSelectedStyles=!1,angular.element(window).on("blur",function(){u._bUpdateSelectedStyles=!1,u.focussed=!1}),u.updateSelectedStyles=function(){var e;C&&t.cancel(C),void 0!==(e=a.getSelectionElement())&&e.parentNode!==u.displayElements.text[0]?S.updateSelectedStyles(angular.element(e)):S.updateSelectedStyles(),u._bUpdateSelectedStyles&&(C=t(u.updateSelectedStyles,200))},g=function(){u.focussed?u._bUpdateSelectedStyles||(u._bUpdateSelectedStyles=!0,u.$apply(function(){u.updateSelectedStyles()})):u._bUpdateSelectedStyles=!1},u.displayElements.html.on("keydown",g),u.displayElements.text.on("keydown",g),h=function(){u._bUpdateSelectedStyles=!1},u.displayElements.html.on("keyup",h),u.displayElements.text.on("keyup",h),v=function(e,t){if(a.getSelection){var n=a.getSelection();a.getSelectionElement()&&"a"===a.getSelectionElement().nodeName.toLowerCase()&&(3===n.start.element.nodeType&&n.start.element.textContent.length===n.end.offset&&a.setSelectionAfterElement(a.getSelectionElement()),3===n.start.element.nodeType&&0===n.start.offset&&a.setSelectionBeforeElement(a.getSelectionElement()))}t&&angular.extend(e,t),u.$apply(function(){if(S.sendKeyCommand(e))return u._bUpdateSelectedStyles||u.updateSelectedStyles(),e.preventDefault(),!1})},u.displayElements.html.on("keypress",v),u.displayElements.text.on("keypress",v),y=function(){u._bUpdateSelectedStyles=!1,t(function(){u.updateSelectedStyles()},0)},u.displayElements.html.on("mouseup",y),u.displayElements.text.on("mouseup",y)}}}]),textAngular.service("textAngularManager",["taToolExecuteAction","taTools","taRegisterTool","$interval","$rootScope","$log",function(e,t,n,a,r,o){var l,i={},s={},d=0,c=function(e){angular.forEach(s,function(t){t.editorFunctions.updateSelectedStyles(e)})};r.$on("destroy",function(){l&&(a.cancel(l),l=void 0)});var u=function(){Math.abs(Date.now()-d)>50&&(d=Date.now(),l=a(function(){c(),l=void 0},50,1))};return{registerEditor:function(n,a,r){if(!n||""===n)throw"textAngular Error: An editor requires a name";if(!a)throw"textAngular Error: An editor requires a scope";if(s[n])throw'textAngular Error: An Editor with name "'+n+'" already exists';return s[n]={scope:a,toolbars:r,toolbarScopes:[],_registerToolbarScope:function(e){this.toolbars.indexOf(e.name)>=0&&this.toolbarScopes.push(e)},editorFunctions:{disable:function(){angular.forEach(s[n].toolbarScopes,function(e){e.disabled=!0})},enable:function(){angular.forEach(s[n].toolbarScopes,function(e){e.disabled=!1})},focus:function(){angular.forEach(s[n].toolbarScopes,function(e){e._parent=a,e.disabled=!1,e.focussed=!0}),a.focussed=!0},unfocus:function(){angular.forEach(s[n].toolbarScopes,function(e){e.disabled=!0,e.focussed=!1}),a.focussed=!1},updateSelectedStyles:function(e){angular.forEach(s[n].toolbarScopes,function(t){angular.forEach(t.tools,function(n){n.activeState&&(t._parent=a,n.active=n.activeState(e))})})},sendKeyCommand:function(r){var o=!1;return(r.ctrlKey||r.metaKey||r.specialKey)&&angular.forEach(t,function(t,l){if(t.commandKeyCode&&(t.commandKeyCode===r.which||t.commandKeyCode===r.specialKey))for(var i=0;i<s[n].toolbarScopes.length;i++)if(void 0!==s[n].toolbarScopes[i].tools[l]){e.call(s[n].toolbarScopes[i].tools[l],a),o=!0;break}}),o},triggerElementSelect:function(e,r){var o=function(e,t){for(var n=!0,a=0;a<t.length;a++)n=n&&e.attr(t[a]);return n},l=[],i={},d=!1;r=angular.element(r);var c=!1;if(angular.forEach(t,function(e,t){e.onElementSelect&&e.onElementSelect.element&&e.onElementSelect.element.toLowerCase()===r[0].tagName.toLowerCase()&&(!e.onElementSelect.filter||e.onElementSelect.filter(r))&&(c=c||angular.isArray(e.onElementSelect.onlyWithAttrs)&&o(r,e.onElementSelect.onlyWithAttrs),e.onElementSelect.onlyWithAttrs&&!o(r,e.onElementSelect.onlyWithAttrs)||(i[t]=e))}),c?(angular.forEach(i,function(e,t){e.onElementSelect.onlyWithAttrs&&o(r,e.onElementSelect.onlyWithAttrs)&&l.push({name:t,tool:e})}),l.sort(function(e,t){return t.tool.onElementSelect.onlyWithAttrs.length-e.tool.onElementSelect.onlyWithAttrs.length})):angular.forEach(i,function(e,t){l.push({name:t,tool:e})}),l.length>0)for(var u=0;u<l.length;u++){for(var p=l[u].tool,f=l[u].name,m=0;m<s[n].toolbarScopes.length;m++)if(void 0!==s[n].toolbarScopes[m].tools[f]){p.onElementSelect.action.call(s[n].toolbarScopes[m].tools[f],e,r,a),d=!0;break}if(d)break}return d}}},angular.forEach(r,function(e){i[e]&&s[n].toolbarScopes.push(i[e])}),u(),s[n].editorFunctions},retrieveEditor:function(e){return s[e]},unregisterEditor:function(e){delete s[e],u()},registerToolbar:function(e){if(!e)throw"textAngular Error: A toolbar requires a scope";if(!e.name||""===e.name)throw"textAngular Error: A toolbar requires a name";if(i[e.name])throw'textAngular Error: A toolbar with name "'+e.name+'" already exists';i[e.name]=e,angular.forEach(s,function(t){t._registerToolbarScope(e)}),u()},retrieveToolbar:function(e){return i[e]},retrieveToolbarsViaEditor:function(e){var t=[],n=this;return angular.forEach(this.retrieveEditor(e).toolbars,function(e){t.push(n.retrieveToolbar(e))}),t},unregisterToolbar:function(e){delete i[e],u()},updateToolsDisplay:function(e){var t=this;angular.forEach(e,function(e,n){t.updateToolDisplay(n,e)})},resetToolsDisplay:function(){var e=this;angular.forEach(t,function(t,n){e.resetToolDisplay(n)}),u()},updateToolDisplay:function(e,t){var n=this;angular.forEach(i,function(a,r){n.updateToolbarToolDisplay(r,e,t)}),u()},resetToolDisplay:function(e){var t=this;angular.forEach(i,function(n,a){t.resetToolbarToolDisplay(a,e)}),u()},updateToolbarToolDisplay:function(e,t,n){if(!i[e])throw'textAngular Error: No Toolbar with name "'+e+'" exists';i[e].updateToolDisplay(t,n)},resetToolbarToolDisplay:function(e,n){if(!i[e])throw'textAngular Error: No Toolbar with name "'+e+'" exists';i[e].updateToolDisplay(n,t[n],!0)},removeTool:function(e){delete t[e],angular.forEach(i,function(t){delete t.tools[e];for(var n=0;n<t.toolbar.length;n++){for(var a,r=0;r<t.toolbar[n].length;r++){if(t.toolbar[n][r]===e){a={group:n,index:r};break}if(void 0!==a)break}void 0!==a&&(t.toolbar[a.group].slice(a.index,1),t._$element.children().eq(a.group).children().eq(a.index).remove())}}),u()},addTool:function(e,t,a,r){n(e,t),angular.forEach(i,function(n){n.addTool(e,t,a,r)}),u()},addToolToToolbar:function(e,t,a,r,o){n(e,t),i[a].addTool(e,t,r,o),u()},refreshEditor:function(e){if(!s[e])throw'textAngular Error: No Editor with name "'+e+'" exists';s[e].scope.updateTaBindtaTextElement(),s[e].scope.$$phase||s[e].scope.$digest(),u()},sendKeyCommand:function(e,t){var n=s[e._name];if(n&&n.editorFunctions.sendKeyCommand(t))return e._bUpdateSelectedStyles||e.updateSelectedStyles(),t.preventDefault(),!1},updateStyles:c,getVersion:function(){return textAngularVersion},getToolbarScopes:function(){var e=[];return angular.forEach(s,function(t){e=e.concat(t.toolbarScopes)}),e}}}]),textAngular.directive("textAngularToolbar",["$compile","textAngularManager","taOptions","taTools","taToolExecuteAction","$window",function(e,t,n,a,r,o){return{scope:{name:"@"},restrict:"EA",link:function(l,i,s){if(!l.name||""===l.name)throw"textAngular Error: A toolbar requires a name";angular.extend(l,angular.copy(n)),s.taToolbar&&(l.toolbar=l.$parent.$eval(s.taToolbar)),s.taToolbarClass&&(l.classes.toolbar=s.taToolbarClass),s.taToolbarGroupClass&&(l.classes.toolbarGroup=s.taToolbarGroupClass),s.taToolbarButtonClass&&(l.classes.toolbarButton=s.taToolbarButtonClass),s.taToolbarActiveButtonClass&&(l.classes.toolbarButtonActive=s.taToolbarActiveButtonClass),s.taFocussedClass&&(l.classes.focussed=s.taFocussedClass),l.disabled=!0,l.focussed=!1,l._$element=i,i[0].innerHTML="",i.addClass("ta-toolbar "+l.classes.toolbar),l.$watch("focussed",function(){l.focussed?i.addClass(l.classes.focussed):i.removeClass(l.classes.focussed)});var d=function(t,n){var a;if(a=t&&t.display?angular.element(t.display):angular.element("<button type='button'>"),t&&t.class?a.addClass(t.class):a.addClass(l.classes.toolbarButton),a.attr("name",n.name),a.attr("ta-button","ta-button"),a.attr("ng-disabled","isDisabled()"),a.attr("tabindex","-1"),a.attr("ng-click","executeAction()"),a.attr("ng-class","displayActiveToolClass(active)"),t&&t.tooltiptext&&a.attr("title",t.tooltiptext),t&&!t.display&&!n._display&&(a[0].innerHTML="",t.buttontext&&(a[0].innerHTML=t.buttontext),t.iconclass)){var r=angular.element("<i>"),o=a[0].innerHTML;r.addClass(t.iconclass),a[0].innerHTML="",a.append(r),o&&""!==o&&a.append("&nbsp;"+o)}return n._lastToolDefinition=angular.copy(t),e(a)(n)};l.tools={},l._parent={disabled:!0,showHtml:!1,queryFormatBlockState:function(){return!1},queryCommandState:function(){return!1}};var c={$window:o,$editor:function(){return l._parent},isDisabled:function(){return("html"!==this.name||!l._parent.startAction)&&("function"!=typeof this.$eval("disabled")&&this.$eval("disabled")||this.$eval("disabled()")||"html"!==this.name&&this.$editor().showHtml||this.$parent.disabled||this.$editor().disabled)},displayActiveToolClass:function(e){return e?l.classes.toolbarButtonActive:""},executeAction:r};angular.forEach(l.toolbar,function(e){var t=angular.element("<div>");t.addClass(l.classes.toolbarGroup),angular.forEach(e,function(e){l.tools[e]=angular.extend(l.$new(!0),a[e],c,{name:e}),l.tools[e].$element=d(a[e],l.tools[e]),t.append(l.tools[e].$element)}),i.append(t)}),l.updateToolDisplay=function(e,t,n){var a=l.tools[e];if(a){if(a._lastToolDefinition&&!n&&(t=angular.extend({},a._lastToolDefinition,t)),null===t.buttontext&&null===t.iconclass&&null===t.display)throw'textAngular Error: Tool Definition for updating "'+e+'" does not have a valid display/iconclass/buttontext value';null===t.buttontext&&delete t.buttontext,null===t.iconclass&&delete t.iconclass,null===t.display&&delete t.display;var r=d(t,a);a.$element.replaceWith(r),a.$element=r}},l.addTool=function(e,t,n,r){var o;l.tools[e]=angular.extend(l.$new(!0),a[e],c,{name:e}),l.tools[e].$element=d(a[e],l.tools[e]),void 0===n&&(n=l.toolbar.length-1),o=angular.element(i.children()[n]),void 0===r?(o.append(l.tools[e].$element),l.toolbar[n][l.toolbar[n].length-1]=e):(o.children().eq(r).after(l.tools[e].$element),l.toolbar[n][r]=e)},t.registerToolbar(l),l.$on("$destroy",function(){t.unregisterToolbar(l.name)})}}}]),textAngular.directive("textAngularVersion",["textAngularManager",function(e){var t=e.getVersion();return{restrict:"EA",link:function(e,n,a){n.html(t)}}}]);
